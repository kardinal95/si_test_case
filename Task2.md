# Миграция базы данных
**Для выполнения задачи мы выполняем следующие шаги**
- Добавляем таблицу с полями *id*, *name* (далее таблица 2) в базу данных
- Добавляем поле *name_id* в исходную таблицу (далее таблица 1)
- Последовательно обновляем сервисы типа А.
Требуемые изменения - добавление записи имени помимо поля *name* в таблице 1 - в таблицу 2 по внешнему ключу *name_id*. 
После обновления сервисов у нас останется некий набор ранее существовавших данных, в которых нет вынесенного в таблицу 2 имени. Все данные созданные обновленными сервисами будут учитывать новый формат данных и работать с ещё не обновленными сервисами типа Б.
- Запускаем скрипт, который должен пройтись по всем записям в таблице 1 и при отсутствии внешнего ключа - проставить его, либо найдя подходящую запись в таблице 2, либо добавив её при необходимости. При этом конфликты могут возникнуть лишь при попытке сервиса типа А записи с идентичным значением в тот же момент (что приведет к дублированию). Избежать этого можно, например, используя уникальность на поле *name* в таблице 2.
После этого шага все записи из таблицы 1 должны быть готовы для работы с новым форматом.
- Последовательно обновляем сервисы типа Б.
Требуемые изменения - обновить метод чтения для использования нового формата данных (из таблицы 2 по внешнему ключу).
После обновления поле *name* в таблице 1 более не читается ни одним из сервисов.
- Обновляем сервисы типа А и удаляем запись в поле *name* в таблице 1. После этого шага поле *name* более не используется
- Удаляем поле *name* из таблицы 1